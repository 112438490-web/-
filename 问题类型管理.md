# OpenSpec提议澄清文档: 问题类型管理

> **Module ID:** problem-type-management
> **PRD来源:** 6.1.1 问题类型管理 (行188-199)
> **PRD文件:** doc/System-Design_text_only.md
> **生成时间:** 2024-12-24
> **文档状态:** 待产品经理审阅

---

<!-- meta:section=2,type=tech_stack -->
## 2. 技术栈 (Technology Stack)

✅ **技术栈已从项目公共知识库自动填充**

### 2.1 后端技术栈
**来源:** COMMON_KNOWLEDGE.md

- **核心框架:** Java 8 + Spring Boot 2.3.2 + Spring Cloud Hoxton.SR9
- **微服务组件:** Spring Cloud Alibaba 2.2.6.RELEASE + Nacos
- **数据持久化:** MySQL (ORM: JPA + MyBatis + MyBatis-Plus)
- **中间件:** Redis + RabbitMQ + MinIO
- **API文档:** Swagger 2.9.2

### 2.2 前端技术栈
**来源:** COMMON_KNOWLEDGE.md

- **核心框架:** React 16.9.0 (JavaScript)
- **UI组件库:** Ant Design 3.26.20 + HVisions自定义组件
- **状态管理:** Redux + redux-thunk
- **路由管理:** React Router 4
- **可视化:** ECharts
- **构建工具:** Webpack + Yarn

### 2.3 DDD领域设计
**来源:** ddd_spec.md

- **所属子域:** 问题配置管理 (ProblemConfiguration)
- **所属聚合:** ProblemTypeAggregate (问题类型聚合)
- **聚合根:** ProblemType (problemTypeId)
- **核心实体:** ProblemType (问题类型)
- **核心命令:** CreateProblemType, UpdateProblemType, ConfigureFlowTemplate, EnableProblemType, DisableProblemType
- **核心事件:** ProblemTypeCreated, ProblemTypeUpdated, FlowConfigurationUpdated

---

<!-- meta:section=3,type=ui_ux -->
## 3. UI/UX资源 (UI/UX Resources)

### 3.1 设计原型
**PRD定位:** [PRD:行193-蓝湖链接]

- 暂无蓝湖设计，依据PRD描述和Ant Design规范进行开发

### 3.2 组件库
- **使用组件库:** Ant Design 3.26.20 + HVisions自定义组件
- **主要组件:** Table (列表), Form (表单), Modal (模态框), Drawer (抽屉), Switch (开关), Select (下拉框)

---

<!-- meta:section=4,type=scope -->
## 4. 范围确认 (Scope Confirmation)

### 4.1 包含的功能
- [x] 问题类型列表查看与查询
- [x] 问题类型新增、复制、编辑
- [x] 问题类型删除(逻辑删除)
- [x] 问题类型启用/禁用
- [x] 8D流程节点配置(拖拽式流程设计器)
- [x] 审批层级配置
- [x] 扩展字段配置

### 4.2 不包含的功能
- [ ] 报告模板配置 (本期不开发)
- [ ] 问题类型的导入导出
- [ ] 问题类型的审批流程
- [ ] 历史版本管理
- [ ] 多语言支持

---

<!-- meta:section=5,type=data_schema -->
## 5. 数据Schema映射 (Data Schema Mapping)

### 5.1 问题类型基础信息表 (problem_type)

| 字段名 | 数据类型 | 必填 | 说明 | PRD定位 |
|--------|---------|------|------|---------|
| problem_type_id | VARCHAR(64) | 是 | 问题类型ID (主键) | [系统生成] |
| problem_type_code | VARCHAR(20) | 是 | 问题类型编码 (QT+五位流水号) | [PRD:行193-QT00004] |
| problem_type_name | VARCHAR(200) | 是 | 问题类型名称 | [PRD:行193] |
| solution_type | VARCHAR(20) | 是 | 解决方式 (8D/精益/简单) | [PRD:行193] |
| remarks | TEXT | 否 | 备注 | [PRD:行193] |
| is_enabled | BOOLEAN | 是 | 是否可用 (默认true) | [PRD:行193] |
| flow_configuration | JSON | 否 | 流程配置 (流程节点和连接关系) | [PRD:行193-流程维护] |
| created_time | DATETIME | 是 | 创建时间 | [PRD:行193] |
| created_by | VARCHAR(64) | 是 | 创建人 | [PRD:行193] |
| updated_time | DATETIME | 是 | 更新时间 | [PRD:行193] |
| updated_by | VARCHAR(64) | 是 | 更新人 | [PRD:行193] |
| is_deleted | BOOLEAN | 是 | 是否删除 (默认false) | [PRD:行193-逻辑删除] |

### 5.2 流程节点配置表 (flow_node_config)

| 字段名 | 数据类型 | 必填 | 说明 | PRD定位 |
|--------|---------|------|------|---------|
| flow_node_id | VARCHAR(64) | 是 | 流程节点ID (主键) | [系统生成] |
| problem_type_id | VARCHAR(64) | 是 | 问题类型ID (外键) | [PRD:行193] |
| node_type | VARCHAR(20) | 是 | 节点类型 (D1~D8/审批) | [PRD:行193-流程节点] |
| node_name | VARCHAR(100) | 是 | 节点名称 | [PRD:行193] |
| node_description | TEXT | 否 | 节点描述 | [PRD:行193-鼠标悬浮描述] |
| node_order | INT | 是 | 节点顺序 | [推断] |
| extension_fields | JSON | 否 | 扩展字段配置 | [PRD:行193-扩展字段] |

### 5.3 审批层级配置表 (approval_level_config)

| 字段名 | 数据类型 | 必填 | 说明 | PRD定位 |
|--------|---------|------|------|---------|
| approval_level_id | VARCHAR(64) | 是 | 审批层级ID (主键) | [系统生成] |
| flow_node_id | VARCHAR(64) | 是 | 流程节点ID (外键,审批节点) | [PRD:行193-审批节点] |
| level_order | INT | 是 | 审批层级顺序 (从1开始) | [PRD:行193-数字从1开始] |
| approval_role | VARCHAR(50) | 是 | 审批角色 (领导/负责人/时间管理员/抄写员/记录员/协调员/成员) | [PRD:行193-审批角色] |

### 5.4 扩展字段配置表 (extension_field_config)

| 字段名 | 数据类型 | 必填 | 说明 | PRD定位 |
|--------|---------|------|------|---------|
| extension_field_id | VARCHAR(64) | 是 | 扩展字段ID (主键) | [系统生成] |
| flow_node_id | VARCHAR(64) | 是 | 流程节点ID (外键) | [PRD:行193] |
| field_order | INT | 是 | 字段顺序 (从1开始) | [PRD:行193-数字1往下排] |
| field_type | VARCHAR(20) | 是 | 字段类型 (文本/文件/图片) | [PRD:行193-扩展字段类型] |
| field_name | VARCHAR(100) | 是 | 字段名称 | [PRD:行193-扩展字段名称] |

---

<!-- meta:section=6,type=operations -->
## 6. 操作详细规范 (Operation Specifications)

<!-- meta:section=6.1,operation_id=op1,prd_section=6.1.1,prd_lines=193,operation_name=列表查看 -->
### 6.1 操作1: 列表查看

<!-- meta:basic_info,operation_id=op1 -->
#### 基本信息
- **操作名称:** 列表查看
- **PRD位置:** [PRD:行193-列表查看]
- **权限要求:** 需要"问题类型查看"权限

<!-- meta:input_spec,operation_id=op1 -->
#### 输入规范

**查询参数:**

| 参数名 | 类型 | 必填 | 说明 | PRD定位 |
|--------|------|------|------|---------|
| page_num | Integer | 否 | 页码 (默认1) | [推断-分页] |
| page_size | Integer | 否 | 每页数量 (默认10) | [推断-分页] |
| problem_type_code | String | 否 | 问题类型编码 (模糊查询) | [PRD:行193-查询条件] |
| problem_type_name | String | 否 | 问题类型名称 (模糊查询) | [PRD:行193-查询条件] |
| solution_type | String | 否 | 解决方式 (8D/精益/简单) | [PRD:行193-查询条件] |
| is_enabled | Boolean | 否 | 是否可用 (是/否) | [PRD:行193-查询条件] |

<!-- meta:output_spec,operation_id=op1 -->
#### 输出规范

**返回数据结构:**

```json
{
  "success": true,
  "data": {
    "total": 100,
    "list": [
      {
        "problemTypeId": "PT001",
        "problemTypeCode": "QT00001",
        "problemTypeName": "尺寸偏差问题",
        "solutionType": "8D",
        "remarks": "适用于加工工序的尺寸问题...",
        "isEnabled": true,
        "createdTime": "2024-01-15 10:30:00",
        "createdBy": "张三",
        "updatedTime": "2024-12-20 14:20:00",
        "updatedBy": "李四"
      }
    ]
  }
}
```

**列表字段:**

| 字段名 | 类型 | 说明 | PRD定位 |
|--------|------|------|---------|
| problemTypeCode | String | 问题类型编码 | [PRD:行193] |
| problemTypeName | String | 问题类型名称 | [PRD:行193] |
| solutionType | String | 解决方式 (8D/精益/简单) | [PRD:行193] |
| remarks | String | 备注 (显示一行,超出显示省略号,鼠标悬浮显示全部) | [PRD:行193-文本量较多] |
| isEnabled | Boolean | 是否可用 (开关控件) | [PRD:行193] |
| createdTime | DateTime | 创建时间 | [PRD:行193] |
| createdBy | String | 创建人 | [PRD:行193] |
| updatedTime | DateTime | 更新时间 | [PRD:行193] |
| updatedBy | String | 更新人 | [PRD:行193] |

<!-- meta:scenarios,operation_id=op1 -->
#### 场景列表

##### Scenario 1: 查看所有问题类型 (P0)
- **WHEN** 用户打开问题类型管理页面,不设置任何查询条件
- **THEN** 系统返回所有未删除的问题类型列表,按创建时间降序排序
- **AND** 支持分页显示,默认每页10条

##### Scenario 2: 按问题类型编码模糊查询 (P0)
- **WHEN** 用户输入问题类型编码"QT001"并点击查询
- **THEN** 系统返回编码包含"QT001"的所有问题类型 (如QT00010, QT00011等)

##### Scenario 3: 按解决方式筛选 (P0)
- **WHEN** 用户选择解决方式"8D"并点击查询
- **THEN** 系统返回所有解决方式为"8D"的问题类型

##### Scenario 4: 按是否可用筛选 (P1)
- **WHEN** 用户选择是否可用"是"并点击查询
- **THEN** 系统返回所有启用状态的问题类型

##### Scenario 5: 组合查询 (P0)
- **WHEN** 用户同时输入问题类型名称"尺寸"和解决方式"8D"
- **THEN** 系统返回名称包含"尺寸"且解决方式为"8D"的问题类型

##### Scenario 6: 无查询结果 (P1)
- **WHEN** 用户查询不存在的问题类型编码
- **THEN** 系统返回空列表,显示"暂无数据"

<!-- meta:errors,operation_id=op1 -->
#### 错误处理

| 错误码 | 错误信息 | 触发条件 | PRD定位 |
|--------|---------|---------|---------|
| 403 | 权限不足,无法查看问题类型 | 用户无"问题类型查看"权限 | [PRD:行193-权限控制] |
| 400 | 分页参数错误 | page_num或page_size为负数或0 | [推断] |

<!-- meta:boundaries,operation_id=op1 -->
#### 边界条件

| 边界条件 | 处理方式 | PRD定位 |
|----------|---------|---------|
| 备注字段超长 | 显示一行,超出部分用省略号代替,鼠标悬浮显示全部内容 | [PRD:行193-文本量较多] |
| 每页最大数量 | 最多100条/页 | [推断] |
| 查询条件为空 | 返回所有未删除的问题类型 | [推断] |

<!-- meta:test_cases,operation_id=op1 -->
#### 测试用例

**Test Case 1: 列表正常显示**
- 前置条件: 数据库存在10条问题类型数据
- 操作: 打开问题类型管理页面
- 预期结果: 显示10条数据,包含所有必要字段

**Test Case 2: 备注字段截断显示**
- 前置条件: 某问题类型的备注超过200字符
- 操作: 查看列表
- 预期结果: 备注显示一行,超出部分显示省略号,鼠标悬浮显示完整内容

---

<!-- meta:section=6.2,operation_id=op2,prd_section=6.1.1,prd_lines=193,operation_name=查询 -->
### 6.2 操作2: 查询

<!-- meta:basic_info,operation_id=op2 -->
#### 基本信息
- **操作名称:** 查询
- **PRD位置:** [PRD:行193-查询]
- **权限要求:** 需要"问题类型查看"权限

<!-- meta:input_spec,operation_id=op2 -->
#### 输入规范

**查询条件 (与操作1相同,详见6.1输入规范)**

<!-- meta:output_spec,operation_id=op2 -->
#### 输出规范

**与操作1相同,详见6.1输出规范**

<!-- meta:scenarios,operation_id=op2 -->
#### 场景列表

**场景与操作1相同,详见6.1场景列表**

<!-- meta:errors,operation_id=op2 -->
#### 错误处理

**与操作1相同,详见6.1错误处理**

<!-- meta:boundaries,operation_id=op2 -->
#### 边界条件

**与操作1相同,详见6.1边界条件**

<!-- meta:test_cases,operation_id=op2 -->
#### 测试用例

**与操作1相同,详见6.1测试用例**

---

<!-- meta:section=6.3,operation_id=op3,prd_section=6.1.1,prd_lines=193,operation_name=新增 -->
### 6.3 操作3: 新增

<!-- meta:basic_info,operation_id=op3 -->
#### 基本信息
- **操作名称:** 新增
- **PRD位置:** [PRD:行193-新增]
- **权限要求:** 需要"问题类型新增"权限
- **页面原型:** 蓝湖-8D-WEB-18.2

<!-- meta:input_spec,operation_id=op3 -->
#### 输入规范

**上-基础信息维护:**

| 字段名 | 类型 | 必填 | 说明 | PRD定位 |
|--------|------|------|------|---------|
| problem_type_code | String | 否 | 问题类型编码 (未输入时自动生成,规则:QT+五位流水号) | [PRD:行193-QT00004] |
| problem_type_name | String | 是 | 问题类型名称 | [PRD:行193] |
| solution_type | String | 是 | 解决方式 (8D/精益/简单,字典) | [PRD:行193] |
| remarks | String | 否 | 备注 (多行文本框) | [PRD:行193] |

**下-流程维护:**

**前置条件:** 必须先保存基础信息,否则拖动流程节点时提示"请先保存基础信息!"

| 字段名 | 类型 | 必填 | 说明 | PRD定位 |
|--------|------|------|------|---------|
| flow_configuration | JSON | 否 | 流程配置 (拖拽式流程设计器) | [PRD:行193-流程维护] |

**流程节点类型:**
- D1组建团队
- D2问题描述
- D3临时措施
- D4根因分析
- D5选择&验证措施
- D6实施永久措施
- D7预防再发生
- D8结项
- 审批节点 (可多次使用)

**审批节点配置 (右侧面板):**

| 字段名 | 类型 | 必填 | 说明 | PRD定位 |
|--------|------|------|------|---------|
| step_node | String | 是 | 步骤节点 (审批的上级节点名称,不可编辑) | [PRD:行193] |
| approval_levels | Array | 是 | 审批层级列表 | [PRD:行193] |
| approval_levels[].level_order | Integer | 是 | 审批层级序号 (从1开始) | [PRD:行193-数字从1开始] |
| approval_levels[].approval_role | String | 是 | 审批角色 (领导/负责人/时间管理员/抄写员/记录员/协调员/成员) | [PRD:行193-字典] |

**步骤扩展信息配置 (右侧面板,D1~D8节点):**

| 字段名 | 类型 | 必填 | 说明 | PRD定位 |
|--------|------|------|------|---------|
| step_node | String | 是 | 步骤节点 (所选择的步骤节点名称,不可编辑) | [PRD:行193] |
| extension_fields | Array | 否 | 扩展字段列表 | [PRD:行193] |
| extension_fields[].field_order | Integer | 是 | 字段顺序 (从1开始) | [PRD:行193-数字1往下排] |
| extension_fields[].field_type | String | 是 | 扩展字段类型 (文本/文件/图片,枚举) | [PRD:行193] |
| extension_fields[].field_name | String | 是 | 扩展字段名称 | [PRD:行193] |

<!-- meta:output_spec,operation_id=op3 -->
#### 输出规范

**保存成功响应:**

```json
{
  "success": true,
  "message": "保存成功",
  "data": {
    "problemTypeId": "PT001",
    "problemTypeCode": "QT00001",
    "problemTypeName": "尺寸偏差问题",
    "solutionType": "8D",
    "remarks": "适用于加工工序的尺寸问题"
  }
}
```

<!-- meta:scenarios,operation_id=op3 -->
#### 场景列表

##### Scenario 1: 新增问题类型(自动生成编码) (P0)
- **WHEN** 用户填写问题类型名称"尺寸偏差问题",选择解决方式"8D",不填写编码,点击保存
- **THEN** 系统自动生成编码(如QT00001),保存成功,返回新问题类型ID

##### Scenario 2: 新增问题类型(手动输入编码) (P0)
- **WHEN** 用户填写问题类型编码"QT99999",名称"测试问题",解决方式"精益",点击保存
- **THEN** 系统使用用户输入的编码,保存成功

##### Scenario 3: 编码重复校验 (P0)
- **WHEN** 用户输入已存在的问题类型编码"QT00001"并点击保存
- **THEN** 系统返回错误"问题类型编码重复,请重新录入",不保存数据

##### Scenario 4: 必填项校验-前端 (P0)
- **WHEN** 用户未填写问题类型名称或未选择解决方式,点击保存
- **THEN** 前端显示错误提示,阻止提交

##### Scenario 5: 配置流程前未保存基础信息 (P1)
- **WHEN** 用户未保存基础信息,直接拖动流程节点
- **THEN** 系统弹出提示"请先保存基础信息!"

##### Scenario 6: 配置完整流程 (P0)
- **WHEN** 用户保存基础信息后,拖入D1~D8节点和审批节点,配置审批层级和扩展字段,点击保存
- **THEN** 系统保存完整的流程配置,包括节点连接关系、审批配置和扩展字段

##### Scenario 7: 审批节点可多次使用 (P1)
- **WHEN** 用户在流程中拖入多个审批节点
- **THEN** 系统允许,每个审批节点独立配置审批层级

##### Scenario 8: 非审批节点只能使用一次 (P1)
- **WHEN** 用户尝试拖入第二个D1节点
- **THEN** 系统阻止,提示"该节点只能使用一次"

<!-- meta:errors,operation_id=op3 -->
#### 错误处理

| 错误码 | 错误信息 | 触发条件 | PRD定位 |
|--------|---------|---------|---------|
| 403 | 权限不足,无法新增问题类型 | 用户无"问题类型新增"权限 | [PRD:行193-权限控制] |
| 400 | 问题类型名称不能为空 | 未填写必填项 | [PRD:行193-必填项] |
| 400 | 解决方式不能为空 | 未选择解决方式 | [PRD:行193-必选] |
| 409 | 问题类型编码重复,请重新录入 | 编码已存在 | [PRD:行193-编码重复校验] |
| 400 | 请先保存基础信息! | 未保存基础信息就配置流程 | [PRD:行193-提前提醒] |

<!-- meta:boundaries,operation_id=op3 -->
#### 边界条件

| 边界条件 | 处理方式 | PRD定位 |
|----------|---------|---------|
| 问题类型编码为空 | 自动生成编码(QT+五位流水号) | [PRD:行193-自动生成] |
| 问题类型名称最大长度 | 限制200字符 | [推断] |
| 备注最大长度 | 限制2000字符 | [推断] |
| 流程节点数量 | D1~D8各最多1个,审批节点无限制 | [PRD:行193-只能选用一次] |
| 审批层级数量 | 每个审批节点最多10个层级 | [推断] |
| 扩展字段数量 | 每个步骤节点最多20个扩展字段 | [推断] |

<!-- meta:test_cases,operation_id=op3 -->
#### 测试用例

**Test Case 1: 新增问题类型-最小信息**
- 操作: 只填写名称"测试问题",选择解决方式"简单",点击保存
- 预期结果: 保存成功,编码自动生成,流程配置为空

**Test Case 2: 新增问题类型-完整信息**
- 操作: 填写所有基础信息,配置完整D1~D8流程,添加审批节点,配置审批层级和扩展字段
- 预期结果: 保存成功,所有配置都正确保存

**Test Case 3: 编码重复校验**
- 前置条件: 数据库已存在编码"QT00001"
- 操作: 新增时输入编码"QT00001"
- 预期结果: 保存失败,提示"问题类型编码重复,请重新录入"

---

<!-- meta:section=6.4,operation_id=op4,prd_section=6.1.1,prd_lines=193,operation_name=复制 -->
### 6.4 操作4: 复制

<!-- meta:basic_info,operation_id=op4 -->
#### 基本信息
- **操作名称:** 复制
- **PRD位置:** [PRD:行193-复制]
- **权限要求:** 需要"问题类型新增"权限
- **交互方式:** 右侧弹出抽屉

<!-- meta:input_spec,operation_id=op4 -->
#### 输入规范

**复制模态框字段:**

| 字段名 | 类型 | 必填 | 可编辑 | 说明 | PRD定位 |
|--------|------|------|--------|------|---------|
| problem_type_code | String | - | 否 | 原问题类型编码 (不可编辑) | [PRD:行193] |
| problem_type_name | String | - | 否 | 原问题类型名称 (不可编辑) | [PRD:行193] |
| new_problem_type_code | String | 否 | 是 | 新问题类型编码 | [PRD:行193-非必输] |
| new_problem_type_name | String | 是 | 是 | 新问题类型名称 | [PRD:行193-必输] |
| remarks | String | 否 | 是 | 备注 (多行文本框) | [PRD:行193-非必输] |

<!-- meta:output_spec,operation_id=op4 -->
#### 输出规范

**复制成功后:**
- 保存一条新的问题类型记录
- 跳转至新问题类型的编辑页面

```json
{
  "success": true,
  "message": "复制成功",
  "data": {
    "problemTypeId": "PT002",
    "problemTypeCode": "QT00002",
    "problemTypeName": "新问题类型名称"
  }
}
```

<!-- meta:scenarios,operation_id=op4 -->
#### 场景列表

##### Scenario 1: 复制问题类型(自动生成新编码) (P0)
- **WHEN** 用户选择问题类型"尺寸偏差问题(QT00001)",点击复制,输入新名称"表面质量问题",不填写新编码,点击保存
- **THEN** 系统自动生成新编码(如QT00002),复制所有配置(解决方式、流程配置、审批配置、扩展字段),保存成功后跳转至新问题类型编辑页面

##### Scenario 2: 复制问题类型(手动输入新编码) (P0)
- **WHEN** 用户选择问题类型"QT00001",点击复制,输入新编码"QT88888",新名称"测试复制",点击保存
- **THEN** 系统使用用户输入的新编码,复制所有配置,保存成功

##### Scenario 3: 复制时新编码重复 (P0)
- **WHEN** 用户输入已存在的新编码"QT00001"
- **THEN** 系统返回错误"问题类型编码重复,请重新录入"

##### Scenario 4: 复制后修改配置 (P1)
- **WHEN** 用户复制成功后跳转至编辑页面,修改流程配置
- **THEN** 系统允许修改,保存时只更新新问题类型,不影响原问题类型

<!-- meta:errors,operation_id=op4 -->
#### 错误处理

| 错误码 | 错误信息 | 触发条件 | PRD定位 |
|--------|---------|---------|---------|
| 403 | 权限不足,无法复制问题类型 | 用户无"问题类型新增"权限 | [PRD:行193-权限控制] |
| 400 | 新问题类型名称不能为空 | 未填写必填项 | [PRD:行193-必输] |
| 409 | 问题类型编码重复,请重新录入 | 新编码已存在 | [PRD:行193-编码重复校验] |
| 404 | 原问题类型不存在 | 选择的原问题类型已删除 | [推断] |

<!-- meta:boundaries,operation_id=op4 -->
#### 边界条件

| 边界条件 | 处理方式 | PRD定位 |
|----------|---------|---------|
| 新编码为空 | 自动生成新编码 | [PRD:行193-非必输] |
| 复制范围 | 复制所有配置(解决方式、流程配置、审批配置、扩展字段),不复制创建/更新信息 | [推断] |

<!-- meta:test_cases,operation_id=op4 -->
#### 测试用例

**Test Case 1: 复制问题类型-自动生成编码**
- 前置条件: 存在问题类型"QT00001"
- 操作: 选择"QT00001",点击复制,输入新名称,点击保存
- 预期结果: 新问题类型编码自动生成,所有配置被复制,跳转至编辑页面

**Test Case 2: 复制问题类型-验证配置独立性**
- 前置条件: 复制成功
- 操作: 在新问题类型中修改流程配置,保存
- 预期结果: 原问题类型的流程配置不变,新问题类型的流程配置已更新

---

<!-- meta:section=6.5,operation_id=op5,prd_section=6.1.1,prd_lines=193,operation_name=详情查看 -->
### 6.5 操作5: 详情查看

<!-- meta:basic_info,operation_id=op5 -->
#### 基本信息
- **操作名称:** 详情查看
- **PRD位置:** [PRD:行193-详情查看]
- **权限要求:** 需要"问题类型查看"权限
- **页面布局:** 与新增页面一致

<!-- meta:input_spec,operation_id=op5 -->
#### 输入规范

**URL参数:**

| 参数名 | 类型 | 必填 | 说明 | PRD定位 |
|--------|------|------|------|---------|
| problem_type_id | String | 是 | 问题类型ID | [推断] |

<!-- meta:output_spec,operation_id=op5 -->
#### 输出规范

**返回完整问题类型数据,字段与操作3输出规范相同**

**页面显示:**
- 所有字段均显示为只读模式
- 右上角显示【编辑】按钮

**编辑模式下的字段编辑权限:**

| 字段名 | 可编辑 | PRD定位 |
|--------|--------|---------|
| problem_type_code | 否 | [PRD:行193-不可编辑] |
| problem_type_name | 否 | [PRD:行193-不可编辑] |
| solution_type | 否 | [PRD:行193-不可编辑] |
| remarks | 是 | [PRD:行193-均可编辑] |
| flow_configuration | 是 | [PRD:行193-均可编辑] |
| extension_fields | 是 | [PRD:行193-均可编辑] |

<!-- meta:scenarios,operation_id=op5 -->
#### 场景列表

##### Scenario 1: 查看问题类型详情 (P0)
- **WHEN** 用户点击列表中的【详情查看】按钮
- **THEN** 系统跳转至详情页面,显示完整问题类型信息,所有字段为只读模式,右上角显示【编辑】按钮

##### Scenario 2: 进入编辑模式 (P0)
- **WHEN** 用户在详情页面点击【编辑】按钮
- **THEN** 部分字段变为可编辑状态(问题类型编码、名称、解决方式不可编辑,其他可编辑)

##### Scenario 3: 编辑并保存 (P0)
- **WHEN** 用户在编辑模式下修改备注和流程配置,点击【保存】
- **THEN** 系统更新问题类型数据,更新时间和更新人信息

##### Scenario 4: 查看不存在的问题类型 (P1)
- **WHEN** 用户访问已删除或不存在的问题类型ID
- **THEN** 系统返回404错误,提示"问题类型不存在"

<!-- meta:errors,operation_id=op5 -->
#### 错误处理

| 错误码 | 错误信息 | 触发条件 | PRD定位 |
|--------|---------|---------|---------|
| 403 | 权限不足,无法查看问题类型详情 | 用户无"问题类型查看"权限 | [PRD:行193-权限控制] |
| 403 | 权限不足,无法编辑问题类型 | 用户无"问题类型编辑"权限 | [推断] |
| 404 | 问题类型不存在 | 问题类型ID不存在或已删除 | [推断] |

<!-- meta:boundaries,operation_id=op5 -->
#### 边界条件

| 边界条件 | 处理方式 | PRD定位 |
|----------|---------|---------|
| 核心字段不可编辑 | 问题类型编码、名称、解决方式不可编辑 | [PRD:行193] |
| 其他字段可编辑 | 备注、流程配置、扩展字段可编辑 | [PRD:行193-均可编辑] |

<!-- meta:test_cases,operation_id=op5 -->
#### 测试用例

**Test Case 1: 查看详情**
- 前置条件: 存在问题类型"QT00001"
- 操作: 点击详情查看
- 预期结果: 显示完整信息,所有字段只读,右上角有【编辑】按钮

**Test Case 2: 编辑核心字段**
- 操作: 点击【编辑】,尝试修改问题类型编码
- 预期结果: 问题类型编码、名称、解决方式不可编辑

**Test Case 3: 编辑其他字段**
- 操作: 点击【编辑】,修改备注和流程配置,点击保存
- 预期结果: 保存成功,更新时间和更新人已更新

---

<!-- meta:section=6.6,operation_id=op6,prd_section=6.1.1,prd_lines=193,operation_name=删除 -->
### 6.6 操作6: 删除

<!-- meta:basic_info,operation_id=op6 -->
#### 基本信息
- **操作名称:** 删除
- **PRD位置:** [PRD:行193-删除]
- **权限要求:** 需要"问题类型删除"权限
- **删除方式:** 逻辑删除

<!-- meta:input_spec,operation_id=op6 -->
#### 输入规范

**请求参数:**

| 参数名 | 类型 | 必填 | 说明 | PRD定位 |
|--------|------|------|------|---------|
| problem_type_id | String | 是 | 问题类型ID | [推断] |

<!-- meta:output_spec,operation_id=op6 -->
#### 输出规范

**删除成功响应:**

```json
{
  "success": true,
  "message": "删除成功"
}
```

<!-- meta:scenarios,operation_id=op6 -->
#### 场景列表

##### Scenario 1: 删除问题类型 (P0)
- **WHEN** 用户点击列表中某问题类型的【删除】按钮
- **THEN** 系统弹出删除提示框"是否删除此条问题类型数据?"
- **AND** 用户点击【确定】后,系统执行逻辑删除(is_deleted=true),列表中不再显示该数据

##### Scenario 2: 取消删除 (P1)
- **WHEN** 用户点击【删除】按钮,弹出提示框
- **THEN** 用户点击【取消】,系统不执行删除操作

##### Scenario 3: 删除不存在的问题类型 (P1)
- **WHEN** 用户尝试删除已删除或不存在的问题类型
- **THEN** 系统返回404错误"问题类型不存在"

<!-- meta:errors,operation_id=op6 -->
#### 错误处理

| 错误码 | 错误信息 | 触发条件 | PRD定位 |
|--------|---------|---------|---------|
| 403 | 权限不足,无法删除问题类型 | 用户无"问题类型删除"权限 | [PRD:行193-权限控制] |
| 404 | 问题类型不存在 | 问题类型ID不存在 | [推断] |
| 409 | 该问题类型正在使用中,无法删除 | 存在关联的质量问题数据 | [推断-业务规则] |

<!-- meta:boundaries,operation_id=op6 -->
#### 边界条件

| 边界条件 | 处理方式 | PRD定位 |
|----------|---------|---------|
| 删除方式 | 逻辑删除(is_deleted=true),不物理删除数据 | [PRD:行193-逻辑删除] |
| 关联数据检查 | 如果存在关联的质量问题,阻止删除 | [推断-业务规则] |

<!-- meta:test_cases,operation_id=op6 -->
#### 测试用例

**Test Case 1: 正常删除**
- 前置条件: 存在未使用的问题类型"QT00001"
- 操作: 点击删除,确认
- 预期结果: 删除成功,列表中不再显示,数据库is_deleted=true

**Test Case 2: 删除正在使用的问题类型**
- 前置条件: 问题类型"QT00001"已被某个质量问题引用
- 操作: 点击删除,确认
- 预期结果: 删除失败,提示"该问题类型正在使用中,无法删除"

---

<!-- meta:section=6.7,operation_id=op7,prd_section=6.1.1,prd_lines=193,operation_name=启用禁用 -->
### 6.7 操作7: 启用/禁用

<!-- meta:basic_info,operation_id=op7 -->
#### 基本信息
- **操作名称:** 启用/禁用
- **PRD位置:** [PRD:行193-启用]
- **权限要求:** 需要"问题类型编辑"权限
- **交互方式:** 开关控件

<!-- meta:input_spec,operation_id=op7 -->
#### 输入规范

**请求参数:**

| 参数名 | 类型 | 必填 | 说明 | PRD定位 |
|--------|------|------|------|---------|
| problem_type_id | String | 是 | 问题类型ID | [推断] |
| is_enabled | Boolean | 是 | 是否启用 (true/false) | [PRD:行193-是否可用] |

<!-- meta:output_spec,operation_id=op7 -->
#### 输出规范

**更新成功响应:**

```json
{
  "success": true,
  "message": "更新成功",
  "data": {
    "problemTypeId": "PT001",
    "isEnabled": true
  }
}
```

<!-- meta:scenarios,operation_id=op7 -->
#### 场景列表

##### Scenario 1: 启用问题类型 (P0)
- **WHEN** 用户点击列表中某问题类型的【是否可用】开关,从关闭切换到打开
- **THEN** 系统更新is_enabled=true,该问题类型可以被新问题引用

##### Scenario 2: 禁用问题类型 (P0)
- **WHEN** 用户点击列表中某问题类型的【是否可用】开关,从打开切换到关闭
- **THEN** 系统更新is_enabled=false,该问题类型不能被新问题引用

##### Scenario 3: 禁用正在使用的问题类型 (P1)
- **WHEN** 用户禁用已被某个进行中的质量问题引用的问题类型
- **THEN** 系统允许禁用,但提示"该问题类型正在使用中,禁用后将不影响已有问题"

<!-- meta:errors,operation_id=op7 -->
#### 错误处理

| 错误码 | 错误信息 | 触发条件 | PRD定位 |
|--------|---------|---------|---------|
| 403 | 权限不足,无法修改问题类型状态 | 用户无"问题类型编辑"权限 | [PRD:行193-权限控制] |
| 404 | 问题类型不存在 | 问题类型ID不存在或已删除 | [推断] |

<!-- meta:boundaries,operation_id=op7 -->
#### 边界条件

| 边界条件 | 处理方式 | PRD定位 |
|----------|---------|---------|
| 禁用后的影响 | 已使用该问题类型的质量问题不受影响,新问题不能选择该类型 | [推断-业务规则] |

<!-- meta:test_cases,operation_id=op7 -->
#### 测试用例

**Test Case 1: 启用问题类型**
- 前置条件: 问题类型"QT00001"状态为禁用
- 操作: 点击开关切换到启用
- 预期结果: is_enabled=true,新问题可以选择该类型

**Test Case 2: 禁用问题类型**
- 前置条件: 问题类型"QT00001"状态为启用
- 操作: 点击开关切换到禁用
- 预期结果: is_enabled=false,新问题不能选择该类型,已有问题不受影响

---

## 8. 技术与业务决策汇总

本节汇总澄清过程中确定的所有关键技术和业务决策：

### 8.1 数据存储决策
- **流程配置存储:** 使用JSON字段存储完整流程图(节点+连接关系)
- **MySQL版本要求:** MySQL 5.7+，使用JSON数据类型
- **审批角色管理:** 使用字典表管理审批角色，支持扩展
- **扩展字段值存储:** 在质量问题表中使用JSON字段存储所有扩展字段值
- **编码生成规则:** 使用数据库自增序列（AUTO_INCREMENT或独立序列表）

### 8.2 前端技术决策
- **流程设计器:** 使用LogicFlow（兼容React 16.9.0）
- **流程JSON格式:** 采用LogicFlow标准数据格式（nodes + edges）
- **流程保存时机:** 手动保存（点击保存按钮）
- **流程节点删除:** 选中节点后点击工具栏删除按钮

### 8.3 业务规则决策
- **流程节点连接规则:** D1~D8节点必须按顺序连接，审批节点可灵活插入
- **流程验证规则:** 允许保存草稿，但启用前必须包含D1~D8所有节点
- **删除逻辑:** 问题类型被引用时阻止删除，提示"正在使用中"
- **禁用逻辑:** 已有问题不受影响，仅新问题不能选择该类型
- **审批流转:** 串行审批（按层级顺序依次审批）
- **审批人员配置:** 在D1组建团队阶段为角色指定具体人员

### 8.4 限制与约束
- **列表分页:** 默认10条/页，最多100条/页
- **备注长度:** 最大1000字符，前端限制+后端验证
- **审批节点:** 最多10个
- **扩展字段:** 每个步骤最多20个
- **审批层级:** 每个审批节点最多10个层级

### 8.5 功能范围
- **包含功能:** 列表查看、查询、新增、复制、编辑、删除、启用/禁用、流程配置、审批配置、扩展字段配置
- **不包含功能:** 报告模板配置（本期不开发）、导入导出、审批流程、历史版本、多语言

---

## Review History

(本节记录产品经理的审阅反馈和修改历史)

---

**文档说明:**
本文档已完成需求澄清，所有待定项已确认。可以进入下一阶段：运行 `/openspec:proposal` 命令生成正式的OpenSpec提议。
